<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>System Bug: Mirror Reflection - Mensajes Dinámicos</title>
    <style>
        :root {
            --medical-blue: #00ffff;
            --medical-pink: #ff00ff;
            --medical-green: #00ff00;
            --medical-purple: #8a2be2;
            --dark-bg: rgba(0, 20, 40, 0.95);
            --darker-bg: rgba(0, 10, 20, 0.98);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: var(--medical-blue);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        /* === CONTENEDORES PRINCIPALES === */
        #container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* === SISTEMA DE MENSAJES MEJORADO === */
        .reflection-message {
            position: absolute;
            color: white;
            font-style: italic;
            text-align: center;
            pointer-events: none;
            z-index: 5;
            background: rgba(0, 0, 0, 0.85);
            padding: 20px 25px;
            border-radius: 12px;
            max-width: 300px;
            font-size: 18px;
            border: 1px solid var(--medical-pink);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.4);
            line-height: 1.4;
            opacity: 0;
            transform: translateY(20px) scale(0.9);
            transition: all 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .reflection-visible {
            opacity: 1 !important;
            transform: translateY(0) scale(1);
        }
        
        .reflection-fade-out {
            opacity: 0;
            transform: translateY(-20px) scale(0.9);
            transition: all 2.5s cubic-bezier(0.55, 0.085, 0.68, 0.53);
        }
        
        /* Posiciones predefinidas para los mensajes */
        .message-top-left {
            top: 15%;
            left: 5%;
            border-color: var(--medical-blue);
        }
        
        .message-top-right {
            top: 12%;
            right: 5%;
            border-color: var(--medical-green);
        }
        
        .message-center-left {
            top: 45%;
            left: 3%;
            border-color: var(--medical-purple);
        }
        
        .message-center-right {
            top: 48%;
            right: 4%;
            border-color: var(--medical-pink);
        }
        
        .message-bottom-left {
            bottom: 20%;
            left: 6%;
            border-color: var(--medical-blue);
        }
        
        .message-bottom-right {
            bottom: 18%;
            right: 5%;
            border-color: var(--medical-green);
        }
        
        .message-center-top {
            top: 25%;
            left: 50%;
            transform: translateX(-50%) translateY(20px) scale(0.9);
            border-color: var(--medical-purple);
        }
        
        .message-center-top.reflection-visible {
            transform: translateX(-50%) translateY(0) scale(1);
        }
        
        .message-center-bottom {
            bottom: 25%;
            left: 50%;
            transform: translateX(-50%) translateY(-20px) scale(0.9);
            border-color: var(--medical-pink);
        }
        
        .message-center-bottom.reflection-visible {
            transform: translateX(-50%) translateY(0) scale(1);
        }

        /* === EFECTOS VISUALES === */
        .glitch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                45deg,
                rgba(255, 0, 0, 0.1),
                rgba(0, 255, 255, 0.1),
                rgba(0, 255, 0, 0.1)
            );
            opacity: 0;
            pointer-events: none;
            mix-blend-mode: overlay;
            z-index: 3;
        }
        
        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                transparent 50%,
                rgba(0, 0, 0, 0.1) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 2;
        }
        
        /* === CONTROLES PRINCIPALES === */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: var(--dark-bg);
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            border: 2px solid var(--medical-blue);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
            backdrop-filter: blur(10px);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .medical-label {
            color: var(--medical-blue);
            font-size: 16px;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
            display: block;
            text-align: center;
            text-transform: uppercase;
        }
        
        .medical-slider {
            width: 100%;
            height: 25px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, var(--medical-blue), var(--medical-pink));
            border-radius: 12px;
            outline: none;
        }
        
        .medical-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 2px solid var(--medical-blue);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        }
        
        .value-display {
            color: var(--medical-green);
            font-size: 18px;
            text-align: center;
            display: block;
            margin-top: 8px;
            font-weight: bold;
        }
        
        /* === BOTONES DE FASES === */
        .phase-buttons {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin: 15px 0;
        }
        
        .phase-btn {
            background: var(--dark-bg);
            color: var(--medical-blue);
            border: 1px solid var(--medical-blue);
            padding: 12px 6px;
            border-radius: 8px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .phase-btn:hover {
            background: rgba(0, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .phase-btn.active {
            background: var(--medical-blue);
            color: black;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }
        
        /* === SIGNOS VITALES === */
        .vital-signs {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 14px;
            color: var(--medical-green);
            background: rgba(0, 20, 40, 0.6);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--medical-green);
        }
        
        .vital {
            text-align: center;
        }
        
        .vital-value {
            font-size: 16px;
            font-weight: bold;
            margin-top: 3px;
        }
        
        /* === PANTALLAS DE ESTADO === */
        #instructions {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--darker-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 25;
            padding: 40px;
            text-align: center;
            border: 3px solid var(--medical-blue);
        }
        
        #instructions h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: var(--medical-blue);
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.7);
            letter-spacing: 3px;
        }
        
        #instructions p {
            font-size: 1.2em;
            margin: 10px 0;
            max-width: 600px;
            line-height: 1.6;
        }
        
        .start-btn {
            background: linear-gradient(45deg, var(--medical-blue), var(--medical-pink));
            color: black;
            border: none;
            padding: 18px 35px;
            font-size: 1.3em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 30px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.5);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 35px rgba(255, 0, 255, 0.6);
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--dark-bg);
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 20;
            border: 2px solid var(--medical-blue);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.4);
        }
        
        #loading p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        
        /* === FPS COUNTER === */
        #fps {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 14px;
            z-index: 10;
            background: var(--dark-bg);
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--medical-green);
            border: 1px solid var(--medical-green);
            font-family: 'Courier New', monospace;
        }
        
        /* === RESPONSIVE DESIGN === */
        @media (max-width: 768px) {
            .phase-buttons {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .reflection-message {
                font-size: 16px;
                padding: 15px 20px;
                max-width: 250px;
            }
            
            #instructions h1 {
                font-size: 2em;
            }
            
            #instructions p {
                font-size: 1em;
            }
        }
        
        /* === ANIMACIONES === */
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
        
        .glitch-animation {
            animation: glitch 0.3s linear;
        }
        
        /* === EFECTO DE TEXTO PARPADEANTE === */
        .blink {
            animation: blink 2s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- ELEMENTOS VISUALES PRINCIPALES -->
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        
        <!-- EFECTOS VISUALES -->
        <div class="glitch-overlay" id="glitch-overlay"></div>
        <div class="scanlines"></div>
        
        <!-- CONTENEDOR PARA MENSAJES DINÁMICOS -->
        <div id="messages-container"></div>
        
        <!-- PANTALLA DE INSTRUCCIONES -->
        <div id="instructions">
            <h1>SYSTEM BUG: MIRROR REFLECTION</h1>
            <p>Una exploración inmersiva sobre la dismorfia corporal y la percepción del yo</p>
            <p>Los mensajes aparecerán lentamente en diferentes posiciones de la pantalla</p>
            <p>Cada reflexión invita a contemplar la relación entre imagen e identidad</p>
            <p class="blink">Permite que los mensajes se desplieguen a su propio ritmo</p>
            <button class="start-btn" onclick="startExperience()">INICIAR EXPERIENCIA</button>
        </div>
        
        <!-- ESTADOS DE CARGA Y ERROR -->
        <div id="loading" style="display: none;">
            <p>INICIALIZANDO SISTEMA DE PERCEPCIÓN VISUAL</p>
            <p>Configurando matriz de mensajes reflexivos...</p>
            <p>Preparando secuencias temporales extendidas...</p>
        </div>
        
        <div id="error" style="display: none;">
            <p>ERROR EN SISTEMA DE CÁMARA</p>
            <p>Verifica permisos o conexión HTTPS</p>
            <button class="close-btn" onclick="initCamera()">REINTENTAR CONEXIÓN</button>
        </div>
        
        <!-- CONTROLES PRINCIPALES -->
        <div id="fps">FPS: 0</div>
        
        <div id="controls" style="display: none;">
            <div class="control-group">
                <label class="medical-label">NIVEL DE DISTORSIÓN PERCEPTUAL</label>
                <input type="range" id="distortion-slider" class="medical-slider" min="0" max="100" value="0">
                <span class="value-display" id="distortion-value">SISTEMA ESTABLE</span>
            </div>
            
            <div class="phase-buttons">
                <button class="phase-btn active" onclick="setPhase(0)">NORMAL</button>
                <button class="phase-btn" onclick="setPhase(1)">TENSIÓN</button>
                <button class="phase-btn" onclick="setPhase(2)">CRISIS</button>
                <button class="phase-btn" onclick="setPhase(3)">FLUIDEZ</button>
                <button class="phase-btn" onclick="setPhase(4)">FRAGMENTACIÓN</button>
                <button class="phase-btn" onclick="setPhase(5)">EXPANSIÓN</button>
                <button class="phase-btn" onclick="setPhase(6)">INTEGRACIÓN</button>
            </div>
            
            <div class="vital-signs">
                <div class="vital">
                    COHERENCIA<br>
                    <span class="vital-value" id="coherence">98%</span>
                </div>
                <div class="vital">
                    ESTABILIDAD<br>
                    <span class="vital-value" id="stability">95%</span>
                </div>
                <div class="vital">
                    MENSAJES<br>
                    <span class="vital-value" id="message-count">0</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // CONFIGURACIÓN Y ELEMENTOS DOM
        // ================================
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const instructions = document.getElementById('instructions');
        const loading = document.getElementById('loading');
        const controls = document.getElementById('controls');
        const distortionSlider = document.getElementById('distortion-slider');
        const distortionValue = document.getElementById('distortion-value');
        const glitchOverlay = document.getElementById('glitch-overlay');
        const messagesContainer = document.getElementById('messages-container');
        const coherenceEl = document.getElementById('coherence');
        const stabilityEl = document.getElementById('stability');
        const messageCountEl = document.getElementById('message-count');
        const fpsEl = document.getElementById('fps');
        
        // ================================
        // ESTADOS Y VARIABLES GLOBALES
        // ================================
        const phases = {
            NORMAL: 0,
            TENSION: 1,
            CRISIS: 2,
            FLUID: 3,
            FRAGMENTATION: 4,
            EXPANSION: 5,
            INTEGRATION: 6
        };
        
        let currentPhase = phases.NORMAL;
        let isRunning = false;
        let animationId;
        let stream;
        let lastTime = 0;
        let frameCount = 0;
        let lastMessageTime = 0;
        let messageCounter = 0;
        let activeMessages = 0;
        
        // Sistema de posiciones para mensajes
        const messagePositions = [
            'message-top-left', 'message-top-right',
            'message-center-left', 'message-center-right', 
            'message-bottom-left', 'message-bottom-right',
            'message-center-top', 'message-center-bottom'
        ];
        
        // Mensajes de reflexión mejorados
        const reflectionMessages = [
            "¿Este reflejo me pertenece realmente?",
            "La imagen vacila entre lo real y lo percibido...",
            "Mi cuerpo como territorio de batalla visual constante",
            "En la distorsión encuentro nuevas formas de ser",
            "¿Dónde termina el cuerpo y empieza la identidad?",
            "Cada parpadeo del sistema revela una verdad diferente",
            "Más allá de la forma física, hay presencia pura",
            "El espejo miente... ¿o soy yo quien no quiere ver?",
            "Entre el yo percibido y el yo real hay un océano de dudas",
            "La distorsión como espejo de la psique fragmentada",
            "¿Qué queda cuando la imagen corporal se desvanece?",
            "En el colapso perceptual encuentro libertad",
            "El cuerpo no es un problema a resolver, sino una experiencia a habitar",
            "Cada distorsión revela una capa de la conciencia",
            "La imagen que veo es un diálogo entre el ser y el parecer",
            "En la fluidez de las formas encuentro mi verdadera esencia",
            "La percepción es un espejo que nunca repite la misma imagen",
            "¿Quién soy más allá de lo que mis ojos pueden ver?",
            "La belleza reside en la imperfección percibida",
            "Cada fragmento de mi reflejo contiene una verdad parcial"
        ];
        
        // ================================
        // SISTEMA DE MENSAJES MEJORADO
        // ================================
        function showReflectionMessage() {
            if (activeMessages >= 3) return; // Máximo 3 mensajes simultáneos
            
            const intensity = parseInt(distortionSlider.value);
            if (intensity < 20) return;
            
            const currentTime = Date.now();
            if (currentTime - lastMessageTime < getMessageInterval(intensity)) return;
            
            // Seleccionar mensaje aleatorio
            const messageIndex = Math.floor(Math.random() * reflectionMessages.length);
            const messageText = reflectionMessages[messageIndex];
            
            // Seleccionar posición aleatoria
            const positionClass = messagePositions[Math.floor(Math.random() * messagePositions.length)];
            
            // Crear elemento de mensaje
            const messageElement = document.createElement('div');
            messageElement.className = `reflection-message ${positionClass}`;
            messageElement.textContent = `"${messageText}"`;
            messageElement.style.opacity = '0';
            messageElement.style.transform = getInitialTransform(positionClass);
            
            messagesContainer.appendChild(messageElement);
            
            // Animación de entrada lenta
            setTimeout(() => {
                messageElement.classList.add('reflection-visible');
                activeMessages++;
                messageCounter++;
                messageCountEl.textContent = messageCounter;
            }, 100);
            
            // Tiempo de visualización extendido (8-15 segundos)
            const displayTime = 8000 + Math.random() * 7000;
            
            // Animación de salida lenta
            setTimeout(() => {
                messageElement.classList.remove('reflection-visible');
                messageElement.classList.add('reflection-fade-out');
                
                // Eliminar elemento después de la animación
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.parentNode.removeChild(messageElement);
                        activeMessages--;
                    }
                }, 2500);
            }, displayTime);
            
            lastMessageTime = currentTime;
        }
        
        function getMessageInterval(intensity) {
            // Los mensajes aparecen más frecuentemente con mayor intensidad
            if (intensity < 30) return 15000; // 15 segundos
            if (intensity < 50) return 12000; // 12 segundos
            if (intensity < 70) return 9000;  // 9 segundos
            if (intensity < 90) return 6000;  // 6 segundos
            return 4000; // 4 segundos para intensidad máxima
        }
        
        function getInitialTransform(positionClass) {
            // Transformaciones iniciales diferentes según la posición
            const transforms = {
                'message-top-left': 'translateY(-20px) translateX(-20px) scale(0.9)',
                'message-top-right': 'translateY(-20px) translateX(20px) scale(0.9)',
                'message-center-left': 'translateX(-30px) scale(0.9)',
                'message-center-right': 'translateX(30px) scale(0.9)',
                'message-bottom-left': 'translateY(20px) translateX(-20px) scale(0.9)',
                'message-bottom-right': 'translateY(20px) translateX(20px) scale(0.9)',
                'message-center-top': 'translateX(-50%) translateY(-30px) scale(0.9)',
                'message-center-bottom': 'translateX(-50%) translateY(30px) scale(0.9)'
            };
            return transforms[positionClass] || 'translateY(20px) scale(0.9)';
        }
        
        // ================================
        // INICIALIZACIÓN DE LA EXPERIENCIA
        // ================================
        function startExperience() {
            instructions.style.display = 'none';
            loading.style.display = 'block';
            initCamera();
        }
        
        async function initCamera() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 },
                        facingMode: 'user'
                    },
                    audio: false
                };
                
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    setupVideo(stream);
                } else {
                    throw new Error('Navegador no compatible con acceso a cámara');
                }
            } catch (err) {
                console.error('Error al acceder a la cámara:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
            }
        }
        
        function setupVideo(mediaStream) {
            video.srcObject = mediaStream;
            
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                loading.style.display = 'none';
                controls.style.display = 'block';
                isRunning = true;
                
                render();
            };
        }
        
        // ================================
        // BUCLE PRINCIPAL DE RENDERIZADO
        // ================================
        function render(currentTime = 0) {
            if (!isRunning || video.readyState !== video.HAVE_ENOUGH_DATA) {
                animationId = requestAnimationFrame(render);
                return;
            }
            
            const intensity = parseInt(distortionSlider.value);
            
            // Dibujar video base
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Aplicar efectos si hay intensidad
            if (intensity > 0) {
                applyDistortionEffects(intensity, currentTime * 0.001);
            }
            
            // Efectos especiales y mensajes
            applySpecialEffects(intensity, currentTime * 0.001);
            
            // Mostrar mensajes reflexivos
            showReflectionMessage();
            
            // Actualizar signos vitales
            updateVitalSigns(intensity);
            
            // Contador FPS
            frameCount++;
            if (currentTime - lastTime >= 1000) {
                fpsEl.textContent = `FPS: ${Math.round(frameCount * 1000 / (currentTime - lastTime))}`;
                frameCount = 0;
                lastTime = currentTime;
            }
            
            animationId = requestAnimationFrame(render);
        }
        
        // ================================
        // SISTEMA DE DISTORSIÓN
        // ================================
        function applyDistortionEffects(intensity, time) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const tempData = new Uint8ClampedArray(data);
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const centerY = height / 2;
            
            for (let y = 0; y < height; y += 2) {
                for (let x = 0; x < width; x += 2) {
                    const idx = (y * width + x) * 4;
                    
                    let newX = x, newY = y;
                    let distortionFactor = intensity / 100;
                    
                    switch(currentPhase) {
                        case phases.NORMAL:
                            newX += Math.sin(y * 0.02 + time) * distortionFactor * 3;
                            newY += Math.cos(x * 0.02 + time) * distortionFactor * 2;
                            break;
                        case phases.TENSION:
                            newX += Math.sin(y * 0.03 + time * 2) * distortionFactor * 6;
                            newY += Math.cos(x * 0.025 + time * 1.5) * distortionFactor * 4;
                            break;
                        case phases.CRISIS:
                            newX += Math.sin(y * 0.04 + time * 3) * distortionFactor * 12;
                            newY += Math.cos(x * 0.03 + time * 2.5) * distortionFactor * 8;
                            break;
                        case phases.FLUID:
                            newX += Math.sin(y * 0.015 + time * 1.2) * distortionFactor * 4;
                            newY += Math.cos(x * 0.012 + time) * distortionFactor * 3;
                            break;
                        case phases.FRAGMENTATION:
                            newX += Math.sin(y * 0.05 + time * 4) * distortionFactor * 8;
                            newY += Math.cos(x * 0.04 + time * 3) * distortionFactor * 6;
                            break;
                        case phases.EXPANSION:
                            const expandDist = Math.sqrt((x - centerX)**2 + (y - centerY)**2);
                            const expand = expandDist * distortionFactor * 0.015;
                            newX += (x - centerX) * expand;
                            newY += (y - centerY) * expand;
                            break;
                        case phases.INTEGRATION:
                            newX += Math.sin(y * 0.01 + time * 0.5) * distortionFactor * 2;
                            newY += Math.cos(x * 0.01 + time * 0.5) * distortionFactor * 2;
                            break;
                    }
                    
                    newX = Math.max(0, Math.min(width - 1, newX));
                    newY = Math.max(0, Math.min(height - 1, newY));
                    
                    const newIdx = (Math.floor(newY) * width + Math.floor(newX)) * 4;
                    
                    if (newIdx + 3 < tempData.length) {
                        data[idx] = tempData[newIdx];
                        data[idx + 1] = tempData[newIdx + 1];
                        data[idx + 2] = tempData[newIdx + 2];
                    }
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        function applySpecialEffects(intensity, time) {
            // Efectos de glitch aleatorios
            if (intensity > 30 && Math.random() < intensity / 200) {
                triggerGlitchEffect(intensity);
            }
        }
        
        function triggerGlitchEffect(intensity) {
            glitchOverlay.style.opacity = '0.3';
            setTimeout(() => {
                glitchOverlay.style.opacity = '0';
            }, 100);
        }
        
        // ================================
        // SISTEMA DE FASES Y CONTROLES
        // ================================
        function setPhase(phase) {
            currentPhase = phase;
            
            document.querySelectorAll('.phase-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === phase);
            });
            
            glitchOverlay.style.opacity = '0.5';
            setTimeout(() => {
                glitchOverlay.style.opacity = '0';
            }, 200);
        }
        
        function updateVitalSigns(intensity) {
            const coherence = Math.max(10, 100 - intensity);
            const stability = Math.max(15, 100 - intensity * 0.7);
            
            coherenceEl.textContent = `${coherence}%`;
            stabilityEl.textContent = `${stability}%`;
            
            coherenceEl.style.color = coherence > 70 ? '#00ff00' : coherence > 40 ? '#ffff00' : '#ff0000';
            stabilityEl.style.color = stability > 70 ? '#00ff00' : stability > 40 ? '#ffff00' : '#ff0000';
        }
        
        // ================================
        // EVENT LISTENERS
        // ================================
        distortionSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            distortionValue.textContent = value === '0' ? 'SISTEMA ESTABLE' : `${value}%`;
        });
        
        // ================================
        // LIMPIEZA
        // ================================
        window.addEventListener('beforeunload', () => {
            isRunning = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>

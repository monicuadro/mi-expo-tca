<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Espejo Distorsionado: Reflexi√≥n Optimizada</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #video, #canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    #controls {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      text-align: center;
      background: rgba(75, 0, 130, 0.7);
      padding: 8px;
      border-radius: 10px;
      width: 90%;
      max-width: 350px;
      transition: opacity 0.3s;
      box-shadow: 0 4px 15px rgba(75, 0, 130, 0.3);
    }
    #controls.hidden { opacity: 0; pointer-events: none; }
    #fps { 
      position: absolute; top: 10px; right: 10px; 
      font-size: 11px; z-index: 10; 
      background: rgba(75, 0, 130, 0.6);
      padding: 4px; border-radius: 5px;
    }
    /* üé∂ Paisaje sonoro */
    #sonido {
      position: fixed;
      bottom: 15px;
      left: 15px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 13px;
      width: 140px;
      z-index: 1000;
    }
    #sonido h3 {
      font-size: 13px;
      margin: 0 0 6px;
      text-align: center;
    }
    #sonido button {
      display: inline-block;
      background: #333;
      color: #fff;
      border: none;
      padding: 5px 8px;
      margin: 2px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    #sonido button:hover { background: #555; }
    #sonido .status {
      margin-top: 6px;
      font-size: 11px;
      text-align: center;
      background: #111;
      padding: 3px;
      border-radius: 4px;
    }
    /* ‚ö†Ô∏è Modal de advertencia */
    .modal {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.75);
    }
    .modal-content {
      background-color: #fff5f5;
      padding: 2em;
      border: 2px solid #d9363e;
      border-radius: 12px;
      max-width: 500px;
      text-align: center;
      color: #333;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .modal-content h2 { color: #d9363e; margin-bottom: 1em; }
    .modal-content ul {
      text-align: left;
      margin: 1em auto;
      max-width: 400px;
    }
    .modal-content button {
      margin: 0.5em;
      padding: 0.8em 1.5em;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
    }
    .accept { background-color: #d9363e; color: white; }
    .accept:hover { background-color: #b52c33; }
    .cancel { background-color: #ccc; color: #333; }
    .cancel:hover { background-color: #999; }
  </style>
</head>
<body>
  <!-- ‚ö†Ô∏è Modal -->
  <div id="warningModal" class="modal">
    <div class="modal-content">
      <h2>‚ö†Ô∏è Aviso de advertencia</h2>
      <p>Esta obra utiliza c√°mara y sonido en tiempo real.  
      Las distorsiones visuales y auditivas pueden resultar perturbadoras.</p>
      <ul>
        <li>No recomendada para personas con <strong>epilepsia fotosensible</strong> o <strong>ansiedad severa</strong>.</li>
        <li>Se recomienda interactuar en un <strong>espacio tranquilo</strong>, con <strong>volumen moderado</strong>.</li>
        <li>El uso de la c√°mara es opcional, pero sin ella la obra no funcionar√° de forma completa.</li>
      </ul>
      <div>
        <button class="accept" onclick="closeModal()">Acepto</button>
        <button class="cancel" onclick="window.location.href='https://google.com'">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="container">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="fps">FPS: 0</div>
    <div id="controls">
      <label for="intensity">Intensidad: <span id="value">0</span></label>
      <input type="range" id="intensity" min="0" max="100" value="0" step="1">
      <button id="distorsion-btn" onclick="toggleDistorsion()">Distorsi√≥n</button>
      <div id="presets">
        <button onclick="setIntensity(25)">Bajo</button>
        <button onclick="setIntensity(50)">Medio</button>
        <button onclick="setIntensity(75)">Alto</button>
        <button onclick="setIntensity(100)">Intenso</button>
        <button id="reset" onclick="resetDistortion()">Reset</button>
      </div>
    </div>
  </div>

  <!-- üîä Paisaje Sonoro -->
  <div id="sonido">
    <h3>Paisaje Sonoro</h3>
    <button onclick="startSoundscape()">‚ñ∂</button>
    <button onclick="stopSoundscape()">‚èπ</button>
    <div class="status" id="status">Listo</div>
  </div>

  <script>
    /* ‚ö†Ô∏è Modal */
    function closeModal() {
      document.getElementById('warningModal').style.display = 'none';
    }

    /* üé∂ Paisaje sonoro inmersivo */
    let audioCtx, masterGain, convolver, timeouts = [], isPlaying = false;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.35;
        convolver = audioCtx.createConvolver();
        const length = audioCtx.sampleRate * 2;
        const impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
        for (let c = 0; c < 2; c++) {
          const data = impulse.getChannelData(c);
          for (let i = 0; i < length; i++) {
            data[i] = (Math.random()*2 - 1) * (1 - i/length);
          }
        }
        convolver.buffer = impulse;
        masterGain.connect(audioCtx.destination);
        convolver.connect(masterGain);
      }
    }
    function updateStatus(text){ document.getElementById('status').textContent = text; }
    function stopSoundscape(){
      isPlaying = false;
      timeouts.forEach(t => clearTimeout(t));
      timeouts = [];
      updateStatus("Detenido");
    }
    function startSoundscape(){
      initAudio();
      stopSoundscape();
      isPlaying = true;
      const now = audioCtx.currentTime;

      function connectWithReverb(node){ node.connect(convolver); node.connect(masterGain); }
      function playDrone(freq,start,dur,vol=0.08,type="sine"){
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain(), panner = audioCtx.createStereoPanner();
        osc.type=type; osc.frequency.value=freq;
        osc.connect(gain); gain.connect(panner); connectWithReverb(panner);
        panner.pan.setValueAtTime(-1,start); panner.pan.linearRampToValueAtTime(1,start+dur);
        gain.gain.setValueAtTime(0,start); gain.gain.linearRampToValueAtTime(vol,start+2);
        gain.gain.linearRampToValueAtTime(0.0001,start+dur);
        osc.start(start); osc.stop(start+dur);
      }
      function heartbeat(time,intensity=0.15){
        const pulse=(off,vol)=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain(),p=audioCtx.createStereoPanner();
          o.frequency.value=60;o.type='sine';o.connect(g);g.connect(p);connectWithReverb(p);
          p.pan.setValueAtTime(Math.random()*2-1,time+off);
          g.gain.setValueAtTime(vol,time+off);g.gain.exponentialRampToValueAtTime(0.001,time+off+0.1);
          o.start(time+off);o.stop(time+off+0.12);}
        pulse(0,intensity);pulse(0.25,intensity*0.8);
      }

      // Fase 1
      updateStatus("Fase 1: Contenci√≥n...");
      playDrone(60, now, 30);
      let beatT=now; for(let i=0;i<12;i++){ heartbeat(beatT,0.1); beatT+=2.2; }

      // Fase 2
      timeouts.push(setTimeout(()=>{
        if(!isPlaying)return;
        updateStatus("Fase 2: Crisis...");
        let t=audioCtx.currentTime;
        for(let i=0;i<40;i++){heartbeat(t+i*0.6,0.22);}
      },30000));

      // Fase 3
      timeouts.push(setTimeout(()=>{
        if(!isPlaying)return;
        updateStatus("Fase 3: Resoluci√≥n...");
        let t=audioCtx.currentTime;
        playDrone(130,t,40,0.05,"triangle");
      },80000));

      timeouts.push(setTimeout(()=>{
        stopSoundscape();
        updateStatus("Experiencia completada ‚ú®");
      },120000));
    }

    /* üé• C√°mara y espejo (tu c√≥digo previo resumido) */
    const video=document.getElementById('video'),canvas=document.getElementById('canvas'),ctx=canvas.getContext('2d');
    const intensitySlider=document.getElementById('intensity'),valueSpan=document.getElementById('value');
    const distorsionBtn=document.getElementById('distorsion-btn'); const fpsEl=document.getElementById('fps');
    let distortionActive=false,animationId,stream,lastTime=0,frameCount=0;

    async function initCamera(){
      try{
        const constraints={video:{facingMode:'user',width:{ideal:640},height:{ideal:480}}};
        stream=await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject=stream;
        video.onloadedmetadata=()=>{canvas.width=video.videoWidth;canvas.height=video.videoHeight;video.play();render();};
      }catch(err){console.error('Error c√°mara:',err);}
    }
    function render(currentTime=0){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        ctx.save();ctx.scale(-1,1);ctx.drawImage(video,-canvas.width,0,canvas.width,canvas.height);ctx.restore();
        if(distortionActive){ /* puedes reinsertar tu distortImage aqu√≠ */ }
        frameCount++; if(currentTime-lastTime>=1000){fpsEl.textContent=`FPS: ${Math.round(frameCount*1000/(currentTime-lastTime))}`;frameCount=0;lastTime=currentTime;}
      }
      animationId=requestAnimationFrame(render);
    }
    function toggleDistorsion(){distortionActive=!distortionActive;distorsionBtn.classList.toggle('active');}
    function setIntensity(v){intensitySlider.value=v;valueSpan.textContent=v;}
    function resetDistortion(){setIntensity(0);distortionActive=false;distorsionBtn.classList.remove('active');}

    initCamera();
  </script>
</body>
</html>

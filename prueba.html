<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Espejo Distorsionado + Paisaje Sonoro</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #video, #canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    #controls {
      position: absolute;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      text-align: center;
      background: rgba(75, 0, 130, 0.7);
      padding: 8px;
      border-radius: 10px;
      width: 90%;
      max-width: 350px;
      box-shadow: 0 4px 15px rgba(75, 0, 130, 0.3);
      transition: opacity 0.3s;
    }
    #controls.hidden { opacity: 0; pointer-events: none; }
    #intensity { width: 100%; height: 22px; margin: 3px 0; }
    #distorsion-btn, #reset, #presets button {
      background: linear-gradient(to right, #4B0082, #2F004F);
      color: #fff;
      border: none;
      padding: 6px 8px;
      margin: 1px;
      border-radius: 8px;
      font-size: 12px;
      min-width: 60px;
    }
    #distorsion-btn {
      background: linear-gradient(to right, #7CFC00, #32CD32);
    }
    #distorsion-btn.active { 
      background: linear-gradient(to right, #32CD32, #228B22);
      transform: scale(1.05);
      box-shadow: 0 2px 10px rgba(124, 252, 0, 0.5);
    }
    #instructions, #loading, #error, #fps {
      position: absolute; z-index: 15;
      background: rgba(75, 0, 130, 0.7);
      padding: 12px; border-radius: 10px;
      text-align: center;
    }
    #instructions { top: 20px; left: 20px; right: 20px; display: none; }
    #loading, #error { top: 50%; left: 50%; transform: translate(-50%, -50%); }
    #fps { top: 10px; right: 10px; font-size: 11px; }
    #presets { display: flex; flex-wrap: wrap; justify-content: space-evenly; gap: 2px; margin-top: 3px; }
    /* --- Botón del paisaje sonoro --- */
    #sonido {
      position: fixed;
      top: 50%;
      left: 5px;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 6px;
      border-radius: 50%;
      font-size: 12px;
      width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      z-index: 1000;
      text-align: center;
    }
    #sonido:hover { background: rgba(255,255,255,0.1); }
    /* --- Modal de advertencia --- */
    #warning-modal {
      position: fixed; top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.9);
      display: flex; align-items: center; justify-content: center;
      z-index: 2000;
    }
    #warning-box {
      background: #111; padding: 20px; border-radius: 10px;
      max-width: 400px; text-align: center;
      color: #fff;
      box-shadow: 0 0 20px rgba(255,0,0,0.5);
    }
    #warning-box h2 { margin-top: 0; color: #ff4444; }
    #warning-box button {
      margin: 10px; padding: 8px 16px;
      border: none; border-radius: 5px; cursor: pointer;
    }
    #accept-btn { background: #28a745; color: white; }
    #cancel-btn { background: #dc3545; color: white; }
  </style>
</head>
<body>
  <!-- Aviso -->
  <div id="warning-modal">
    <div id="warning-box">
      <h2>⚠️ Aviso de advertencia</h2>
      <p>Esta obra usa cámara y paisaje sonoro con efectos de distorsión.</p>
      <p>- Puede ser perturbador para personas con epilepsia fotosensible o ansiedad.<br>
         - Recomendado en un espacio tranquilo y con volumen moderado.</p>
      <p>¿Deseas continuar?</p>
      <button id="accept-btn">Aceptar</button>
      <button id="cancel-btn">Cancelar</button>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div id="container" style="display:none;">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="instructions">
      <h2>Espejo Distorsionado</h2>
      <p>Explora distorsiones en tu reflejo. Usa la cámara frontal.</p>
      <button onclick="closeInstructions()">Iniciar Experiencia</button>
    </div>
    <div id="loading">Cargando cámara...</div>
    <div id="error" style="display:none;">
      <p>Error en cámara.</p>
      <button onclick="initCamera()">Reintentar</button>
    </div>
    <div id="fps">FPS: 0</div>
    <div id="controls">
      <label for="intensity">Intensidad: <span id="value">0</span></label>
      <input type="range" id="intensity" min="0" max="100" value="0">
      <button id="distorsion-btn" onclick="toggleDistorsion()">Distorsión</button>
      <div id="presets">
        <button onclick="setIntensity(25)">Bajo</button>
        <button onclick="setIntensity(50)">Medio</button>
        <button onclick="setIntensity(75)">Alto</button>
        <button onclick="setIntensity(100)">Intenso</button>
        <button id="reset" onclick="resetDistortion()">Reset</button>
      </div>
    </div>
    <!-- Botón del paisaje sonoro -->
    <div id="sonido" onclick="toggleSoundscape()">▶</div>
  </div>

  <script>
    /********** AVISO **********/
    const warningModal = document.getElementById('warning-modal');
    const container = document.getElementById('container');
    document.getElementById('accept-btn').onclick = () => {
      warningModal.style.display = 'none';
      container.style.display = 'flex';
      initCamera();
    };
    document.getElementById('cancel-btn').onclick = () => {
      window.location.href = "https://www.google.com";
    };

    /********** ESPEJO DISTORSIONADO **********/
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const intensitySlider = document.getElementById('intensity');
    const valueSpan = document.getElementById('value');
    const distorsionBtn = document.getElementById('distorsion-btn');
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const fpsEl = document.getElementById('fps');
    const instructions = document.getElementById('instructions');
    let distortionActive = false, animationId, stream, lastTime=0, frameCount=0;

    async function initCamera() {
      try {
        loading.style.display = 'block'; error.style.display='none';
        const constraints = { video: { facingMode:'user', width:640, height:480 }};
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth; canvas.height = video.videoHeight;
          loading.style.display = 'none'; instructions.style.display = 'block'; video.play(); render();
        };
      } catch (err) {
        loading.style.display='none'; error.style.display='block'; console.error(err);
      }
    }

    function render(currentTime=0) {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.save(); ctx.scale(-1,1);
        ctx.drawImage(video, -canvas.width,0,canvas.width,canvas.height);
        ctx.restore();
        const intensity = parseInt(intensitySlider.value);
        if (distortionActive && intensity>0) distortImage(intensity, currentTime*0.001);
        frameCount++; if (currentTime-lastTime>=1000){ fpsEl.textContent=`FPS:${frameCount}`; frameCount=0; lastTime=currentTime; }
      }
      animationId = requestAnimationFrame(render);
    }

    function distortImage(intensity,time) {
      let imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
      let src=new Uint8ClampedArray(imageData.data); let dest=new Uint8ClampedArray(src.length);
      const w=canvas.width,h=canvas.height,cx=w/2,cy=h/2;
      for(let y=0;y<h;y++){for(let x=0;x<w;x++){
        let dx=Math.sin(y*0.02+time*2)*(intensity/100)*8;
        let dy=Math.cos(x*0.015+time*3)*(intensity/100)*6;
        const d=Math.sqrt((x-cx)**2+(y-cy)**2);
        if(d<150){const f=(150-d)/150*(intensity/100)*0.03; dx+=(x-cx)*f; dy+=(y-cy)*f;}
        let srcX=w-(x+dx),srcY=y+dy; srcX=Math.max(0,Math.min(w-1,srcX)); srcY=Math.max(0,Math.min(h-1,srcY));
        const i=(Math.floor(srcY)*w+Math.floor(srcX))*4;
        for(let c=0;c<3;c++) dest[(y*w+x)*4+c]=src[i+c];
        dest[(y*w+x)*4+3]=255;
      }}
      imageData.data.set(dest); ctx.putImageData(imageData,0,0);
    }

    intensitySlider.oninput=e=>valueSpan.textContent=e.target.value;
    function toggleDistorsion(){ distortionActive=!distortionActive; distorsionBtn.classList.toggle('active'); }
    function setIntensity(v){ intensitySlider.value=v; valueSpan.textContent=v; }
    function resetDistortion(){ setIntensity(0); distortionActive=false; distorsionBtn.classList.remove('active'); }
    function closeInstructions(){ instructions.style.display='none'; }

    /********** PAISAJE SONORO **********/
    let audioCtx, masterGain, isPlaying=false;
    function initAudio(){
      if(!audioCtx){
        audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        masterGain=audioCtx.createGain(); masterGain.gain.value=0.3;
        masterGain.connect(audioCtx.destination);
      }
    }
    function toggleSoundscape(){
      if(isPlaying){ masterGain.gain.setValueAtTime(0,audioCtx.currentTime); isPlaying=false; document.getElementById("sonido").textContent="▶"; }
      else { initAudio(); playDrone(); isPlaying=true; document.getElementById("sonido").textContent="■"; }
    }
    function playDrone(){
      const osc=audioCtx.createOscillator(); osc.type="sine"; osc.frequency.value=100;
      const gain=audioCtx.createGain(); gain.gain.value=0.2; osc.connect(gain); gain.connect(masterGain);
      osc.start(); osc.stop(audioCtx.currentTime+5);
    }
  </script>
</body>
</html>

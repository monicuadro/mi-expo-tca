<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dismorfia – Obra Interactiva</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      color: white;
      font-family: sans-serif;
    }

    video, canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }

    /* Modal de advertencia */
    .modal {
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #111;
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 0 15px rgba(255,255,255,0.2);
    }
    .modal-content h2 { margin-top: 0; color: #f33; }
    .modal-content ul { text-align: left; }
    .modal-content button {
      margin: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .accept { background: #0a0; color: white; }
    .cancel { background: #333; color: white; }

    /* Botón de sonido */
    #sonido {
      position: fixed;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 20px;
      padding: 12px;
      border-radius: 50%;
      cursor: pointer;
      z-index: 1500;
      user-select: none;
    }
    #sonido:hover {
      background: rgba(255,255,255,0.2);
    }
  </style>
</head>
<body>
  <!-- Modal de advertencia -->
  <div id="warningModal" class="modal">
    <div class="modal-content">
      <h2>⚠️ Aviso de advertencia</h2>
      <p>Esta obra utiliza cámara y sonido en tiempo real.  
      Las distorsiones visuales y auditivas pueden resultar perturbadoras.</p>
      <ul>
        <li>No recomendada para personas con <strong>epilepsia fotosensible</strong> o <strong>ansiedad severa</strong>.</li>
        <li>Se recomienda interactuar en un <strong>espacio tranquilo</strong>, con <strong>volumen moderado</strong>.</li>
        <li>El uso de la cámara es opcional, pero sin ella la obra no funcionará de forma completa.</li>
      </ul>
      <div>
        <button class="accept" onclick="closeModal()">Acepto</button>
        <button class="cancel" onclick="window.location.href='https://google.com'">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Obra visual -->
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>

  <!-- Botón de paisaje sonoro -->
  <div id="sonido" onclick="toggleSoundscape()">▶</div>

  <!-- Script modal -->
  <script>
    function closeModal() {
      document.getElementById('warningModal').style.display = 'none';
      startCamera();
    }
  </script>

  <!-- Script obra visual -->
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => { video.srcObject = stream; })
        .catch(err => console.error("Error cámara:", err));
    }

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    function draw() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      let data = imageData.data;
      // Distorsión tipo onda
      for (let y = 0; y < canvas.height; y+=2) {
        for (let x = 0; x < canvas.width; x+=2) {
          let index = (y * canvas.width + x) * 4;
          let offset = Math.sin(y / 20) * 20;
          let newX = (x + offset) % canvas.width;
          if (newX < 0) newX += canvas.width;
          let newIndex = (y * canvas.width + Math.floor(newX)) * 4;
          data[index] = data[newIndex];
          data[index+1] = data[newIndex+1];
          data[index+2] = data[newIndex+2];
        }
      }
      ctx.putImageData(imageData, 0, 0);
      requestAnimationFrame(draw);
    }
    video.addEventListener('play', () => { draw(); });
  </script>

  <!-- Script paisaje sonoro -->
  <script>
    let audioCtx;
    let oscillator, noise, gainNode;
    let soundscapeActive = false;

    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function startSoundscape() {
      if (!audioCtx) initAudio();

      gainNode = audioCtx.createGain();
      gainNode.gain.value = 0.15;
      gainNode.connect(audioCtx.destination);

      // Oscilador base
      oscillator = audioCtx.createOscillator();
      oscillator.type = "sine";
      oscillator.frequency.setValueAtTime(220, audioCtx.currentTime);
      oscillator.connect(gainNode);
      oscillator.start();

      // Ruido blanco
      const bufferSize = 2 * audioCtx.sampleRate;
      const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) {
        data[i] = Math.random() * 2 - 1;
      }
      noise = audioCtx.createBufferSource();
      noise.buffer = buffer;
      noise.loop = true;
      const noiseFilter = audioCtx.createBiquadFilter();
      noiseFilter.type = "lowpass";
      noiseFilter.frequency.setValueAtTime(1000, audioCtx.currentTime);
      noise.connect(noiseFilter);
      noiseFilter.connect(gainNode);
      noise.start();

      soundscapeActive = true;
      document.getElementById("sonido").textContent = "⏸";
    }

    function stopSoundscape() {
      if (oscillator) oscillator.stop();
      if (noise) noise.stop();
      soundscapeActive = false;
      document.getElementById("sonido").textContent = "▶";
    }

    function toggleSoundscape() {
      if (!soundscapeActive) {
        startSoundscape();
      } else {
        stopSoundscape();
      }
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Espejo Distorsionado: Reflexión y Dismorfia Corporal</title>
<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #0f0f23 0%, #1a0d2e 50%, #2d1b69 100%);
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    box-sizing: border-box;
  }

  h1 {
    font-size: 1.8rem;
    font-weight: 300;
    margin: 20px 0 10px;
    text-align: center;
    letter-spacing: 1px;
    color: #e0d7ff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  p.description {
    max-width: 600px;
    text-align: center;
    font-size: 1rem;
    line-height: 1.5;
    margin: 0 0 20px;
    color: #d1d5db;
    opacity: 0.9;
  }

  #stage {
    position: relative;
    width: 480px;
    height: 640px;
    margin: 20px 0;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 
      0 10px 30px rgba(139, 92, 246, 0.3),
      0 4px 20px rgba(0,0,0,0.4),
      inset 0 2px 4px rgba(255,255,255,0.1);
    transition: box-shadow 0.3s ease;
  }

  #stage:hover {
    box-shadow: 
      0 15px 40px rgba(139, 92, 246, 0.4),
      0 6px 25px rgba(0,0,0,0.5),
      inset 0 2px 4px rgba(255,255,255,0.1);
  }

  video, canvas {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 16px;
  }

  #controls {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    align-items: center;
    width: 100%;
    max-width: 480px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: 100%;
    align-items: center;
  }

  label {
    font-size: 0.95rem;
    color: #e0d7ff;
    font-weight: 500;
    margin-bottom: 4px;
  }

  #intensity {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(255,255,255,0.1);
    outline: none;
    -webkit-appearance: none;
  }

  #intensity::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8B5CF6, #A78BFA);
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
  }

  #intensity::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8B5CF6, #A78BFA);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
  }

  .btn-group {
    display: flex;
    gap: 12px;
    width: 100%;
    justify-content: center;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 12px;
    border: none;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    min-width: 140px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }

  #start {
    background: linear-gradient(135deg, #8B5CF6, #A78BFA);
    color: #fff;
  }

  #start:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
  }

  #stop {
    background: linear-gradient(135deg, #6B7280, #9CA3AF);
    color: #fff;
  }

  #stop:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
  }

  .btn:active {
    transform: translateY(0);
  }

  @media (max-width: 600px) {
    #stage {
      width: 100%;
      max-width: 480px;
      height: auto;
      aspect-ratio: 480/640;
    }
    
    h1 {
      font-size: 1.5rem;
    }
    
    .btn-group {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<h1>Espejo Distorsionado</h1>
<p class="description">
  Esta experiencia te invita a mirarte en un espejo digital que distorsiona tu reflejo, explorando la dismorfia corporal. Ajusta la intensidad para ver cómo la percepción de tu imagen puede alterarse, recordándonos cómo el cuerpo se ve a través de lentes subjetivos. Usa la cámara frontal para una reflexión íntima y reflexiva.
</p>

<div id="stage">
  <video id="video" autoplay playsinline></video>
  <canvas id="out"></canvas>
</div>

<div id="controls">
  <div class="control-group">
    <label for="intensity">Intensidad de Distorsión (0-100)</label>
    <input id="intensity" type="range" min="0" max="100" value="0">
  </div>
  
  <div class="btn-group">
    <button id="start" class="btn">Iniciar Experiencia</button>
    <button id="stop" class="btn">Restaurar Espejo</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0.5/dist/body-pix.min.js"></script>
<script>
(async function(){
  const video = document.getElementById('video');
  const out = document.getElementById('out');
  const intensity = document.getElementById('intensity');
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');

  const W = 480, H = 640;
  out.width = W; out.height = H;

  let net = null, running=false, offCanvas = document.createElement('canvas');
  offCanvas.width = W; offCanvas.height = H;
  const offCtx = offCanvas.getContext('2d');
  const outCtx = out.getContext('2d');

  async function setupCamera(){
    const stream = await navigator.mediaDevices.getUserMedia({
      video:{facingMode:'user', width: W, height: H}, audio:false
    });
    video.srcObject = stream;
    await video.play();
  }

  async function loadModel(){
    net = await bodyPix.load({architecture:'MobileNetV1', outputStride:16, multiplier:0.5});
  }

  async function frameLoop(){
    if(!running) return;
    offCtx.save();
    offCtx.scale(-1,1);
    offCtx.drawImage(video, -W, 0, W, H);
    offCtx.restore();

    const segmentation = await net.segmentPerson(offCanvas, {internalResolution: 'medium', segmentationThreshold: 0.7});
    const mask = bodyPix.toMask(segmentation, {r:0,g:0,b:0,a:0}, {r:0,g:0,b:0,a:255});
    outCtx.clearRect(0,0,W,H);
    outCtx.globalAlpha = 0.4;
    outCtx.drawImage(offCanvas,0,0);
    outCtx.globalAlpha = 1.0;

    const maskCanvas = document.createElement('canvas');
    maskCanvas.width = W; maskCanvas.height = H;
    maskCanvas.getContext('2d').putImageData(mask,0,0);

    const temp = document.createElement('canvas');
    temp.width=W; temp.height=H;
    const tctx = temp.getContext('2d');
    tctx.drawImage(offCanvas,0,0);
    tctx.globalCompositeOperation = 'destination-in';
    tctx.drawImage(maskCanvas,0,0);

    const amp = parseFloat(intensity.value)/30;
    const slice = 6;
    
    // Distorsión horizontal original (ondulación izquierda-derecha)
    for(let x=0; x<W; x+=slice){
      const dx = Math.round(Math.sin((x/20) + performance.now()/400) * amp*10);
      const col = tctx.getImageData(x,0,slice,H);
      outCtx.putImageData(col, x + dx, 0);
    }
    
    // Nuevo efecto: Distorsión vertical (ondulación arriba-abajo) para mayor impacto en dismorfia
    const verticalTemp = document.createElement('canvas');
    verticalTemp.width = W; verticalTemp.height = H;
    const vctx = verticalTemp.getContext('2d');
    vctx.drawImage(out, 0, 0); // Usar el canvas distorsionado horizontal como base
    for(let y=0; y<H; y+=slice){
      const dy = Math.round(Math.sin((y/30) + performance.now()/300) * amp*8);
      const row = vctx.getImageData(0, y, W, slice);
      outCtx.putImageData(row, 0, y + dy);
    }

    if(intensity.value > 1){
      outCtx.fillStyle = `rgba(200,100,150,${intensity.value/400})`;
      outCtx.fillRect(0,0,W,H);
    }

    requestAnimationFrame(frameLoop);
  }

  startBtn.onclick = async ()=>{
    if(running) return;
    await setupCamera();
    await loadModel();
    running = true;
    frameLoop();
    startBtn.textContent = 'Experiencia Activa';
    startBtn.style.opacity = '0.7';
  };
  
  stopBtn.onclick = ()=>{
    running = false;
    outCtx.clearRect(0,0,W,H);
    outCtx.save();
    outCtx.scale(-1,1);
    outCtx.drawImage(video, -W, 0, W, H);
    outCtx.restore();
    startBtn.textContent = 'Iniciar Experiencia';
    startBtn.style.opacity = '1';
  };
})();
</script>
</body>
</html>

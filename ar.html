<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>System Bug AR - Experiencia de Realidad Aumentada</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --medical-blue: #00ffff;
            --medical-pink: #ff00ff;
            --medical-green: #00ff00;
            --medical-purple: #8a2be2;
            --dark-bg: rgba(0, 20, 40, 0.95);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: var(--medical-blue);
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
            touch-action: none;
        }
        
        /* === CONTENEDORES PRINCIPALES === */
        #container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: 1;
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        #three-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
        }
        
        /* === INTERFAZ AR === */
        #ar-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
        }
        
        .face-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--medical-pink);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px currentColor;
            pointer-events: none;
        }
        
        .distortion-wave {
            position: absolute;
            border: 2px solid var(--medical-blue);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            animation: waveExpand 2s linear infinite;
        }
        
        @keyframes waveExpand {
            0% { 
                width: 20px; 
                height: 20px; 
                opacity: 1; 
            }
            100% { 
                width: 200px; 
                height: 200px; 
                opacity: 0; 
            }
        }
        
        /* === CONTROLES AR === */
        #ar-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            background: var(--dark-bg);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid var(--medical-blue);
            backdrop-filter: blur(10px);
            pointer-events: auto;
            display: none;
        }
        
        .ar-btn {
            background: transparent;
            color: var(--medical-blue);
            border: 1px solid var(--medical-blue);
            padding: 10px 15px;
            margin: 0 5px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        
        .ar-btn:hover {
            background: var(--medical-blue);
            color: black;
        }
        
        .ar-btn.active {
            background: var(--medical-blue);
            color: black;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
        }
        
        /* === PANTALLAS DE ESTADO === */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 30;
            background: var(--dark-bg);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--medical-blue);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
        }
        
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            z-index: 25;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        #error-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            z-index: 35;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .start-btn {
            background: linear-gradient(45deg, var(--medical-blue), var(--medical-pink));
            color: black;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 10px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        /* === EFECTOS VISUALES === */
        .glitch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                45deg,
                rgba(255, 0, 0, 0.1),
                rgba(0, 255, 255, 0.1),
                rgba(0, 255, 0, 0.1)
            );
            opacity: 0;
            pointer-events: none;
            mix-blend-mode: overlay;
            z-index: 4;
        }
        
        .ar-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-style: italic;
            text-align: center;
            pointer-events: none;
            z-index: 5;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--medical-pink);
            opacity: 0;
            transition: opacity 2s;
            max-width: 80%;
        }
        
        .message-visible {
            opacity: 1 !important;
        }
        
        /* === ANIMACIONES === */
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .float {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- ELEMENTOS VISUALES -->
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
        <canvas id="three-canvas"></canvas>
        
        <!-- INTERFAZ AR -->
        <div id="ar-interface"></div>
        
        <!-- EFECTOS -->
        <div class="glitch-overlay" id="glitch-overlay"></div>
        
        <!-- PANTALLAS DE ESTADO -->
        <div id="start-screen">
            <h1 class="float">SYSTEM BUG AR</h1>
            <p>Experiencia de Realidad Aumentada</p>
            <p>Distorsiones faciales en tiempo real</p>
            <p class="pulse">Permite el acceso a tu cámara para comenzar</p>
            <button class="start-btn" onclick="startARExperience()">INICIAR EXPERIENCIA AR</button>
        </div>
        
        <div id="loading" style="display: none;">
            <h2>INICIALIZANDO SISTEMA AR</h2>
            <p>Cargando modelos de IA...</p>
            <p>Calibrando seguimiento facial...</p>
            <p>Preparando distorsiones en tiempo real...</p>
        </div>
        
        <div id="error-screen">
            <h2>ERROR EN SISTEMA AR</h2>
            <p>No se pudo acceder a la cámara</p>
            <p>Verifica los permisos y recarga la página</p>
            <button class="start-btn" onclick="location.reload()">REINTENTAR</button>
        </div>
        
        <!-- CONTROLES AR -->
        <div id="ar-controls">
            <button class="ar-btn" onclick="setARDistortionMode('soft')">SUAVE</button>
            <button class="ar-btn active" onclick="setARDistortionMode('medium')">MEDIO</button>
            <button class="ar-btn" onclick="setARDistortionMode('intense')">INTENSO</button>
            <button class="ar-btn" onclick="setARDistortionMode('chaos')">CAOS</button>
        </div>
        
        <!-- MENSAJES AR -->
        <div class="ar-message" id="ar-message"></div>
    </div>

    <script>
        // ================================
        // CONFIGURACIÓN Y ELEMENTOS DOM
        // ================================
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const threeCanvas = document.getElementById('three-canvas');
        const startScreen = document.getElementById('start-screen');
        const loadingScreen = document.getElementById('loading');
        const errorScreen = document.getElementById('error-screen');
        const arControls = document.getElementById('ar-controls');
        const arInterface = document.getElementById('ar-interface');
        const glitchOverlay = document.getElementById('glitch-overlay');
        const arMessage = document.getElementById('ar-message');
        
        // ================================
        // VARIABLES GLOBALES
        // ================================
        let faceModel;
        let isARActive = false;
        let currentDistortionMode = 'medium';
        let animationId;
        let stream;
        let scene, camera, renderer, particles;
        
        // Mensajes para la experiencia AR
        const arMessages = [
            "Tu rostro se transforma en el espacio digital",
            "¿Qué es real cuando la percepción fluctúa?",
            "Cada punto traza la geografía de tu identidad",
            "En la distorsión encuentro nuevas formas de ser",
            "La realidad aumentada revela capas ocultas",
            "Tu reflejo digital tiene vida propia",
            "Los algoritmos reinterpretan tu imagen",
            "¿Dónde terminas tú y empieza la máquina?",
            "La tecnología como espejo de la psique",
            "Cada movimiento crea ondulaciones en el espacio digital"
        ];
        
        // ================================
        // INICIALIZACIÓN THREE.JS
        // ================================
        function initThreeJS() {
            // Configurar escena Three.js
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: threeCanvas, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0);
            
            // Crear partículas flotantes
            createParticles();
            
            // Posicionar cámara
            camera.position.z = 5;
        }
        
        function createParticles() {
            const particleCount = 100;
            const particles = new THREE.BufferGeometry();
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 10;
                positions[i + 1] = (Math.random() - 0.5) * 10;
                positions[i + 2] = (Math.random() - 0.5) * 10;
                
                colors[i] = Math.random() > 0.5 ? 1 : 0; // R
                colors[i + 1] = Math.random() > 0.5 ? 1 : 0; // G
                colors[i + 2] = Math.random() > 0.5 ? 1 : 0; // B
            }
            
            particles.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particles.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            const particleMaterial = new THREE.PointsMaterial({
                size: 0.1,
                vertexColors: true,
                transparent: true,
                opacity: 0.6
            });
            
            const particleSystem = new THREE.Points(particles, particleMaterial);
            scene.add(particleSystem);
            
            // Animación de partículas
            function animateParticles() {
                if (!isARActive) return;
                
                const positions = particleSystem.geometry.attributes.position.array;
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i] += (Math.random() - 0.5) * 0.02;
                    positions[i + 1] += (Math.random() - 0.5) * 0.02;
                    positions[i + 2] += (Math.random() - 0.5) * 0.02;
                }
                particleSystem.geometry.attributes.position.needsUpdate = true;
                
                particleSystem.rotation.y += 0.001;
                
                requestAnimationFrame(animateParticles);
                renderer.render(scene, camera);
            }
            animateParticles();
        }
        
        // ================================
        // INICIALIZACIÓN AR
        // ================================
        async function startARExperience() {
            startScreen.style.display = 'none';
            loadingScreen.style.display = 'block';
            
            try {
                await setupCamera();
                await loadFaceModel();
                initThreeJS();
                startScreen.style.display = 'none';
                loadingScreen.style.display = 'none';
                arControls.style.display = 'block';
                isARActive = true;
                startFaceTracking();
            } catch (error) {
                console.error('Error iniciando AR:', error);
                loadingScreen.style.display = 'none';
                errorScreen.style.display = 'flex';
            }
        }
        
        async function setupCamera() {
            const constraints = {
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user',
                    frameRate: { ideal: 30 }
                }
            };
            
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                });
            } catch (error) {
                throw new Error('No se pudo acceder a la cámara');
            }
        }
        
        async function loadFaceModel() {
            try {
                await tf.setBackend('webgl');
                faceModel = await faceLandmarksDetection.load(
                    faceLandmarksDetection.SupportedPackages.mediapipeFacemesh,
                    { maxFaces: 1 }
                );
            } catch (error) {
                throw new Error('Error cargando modelo de reconocimiento facial');
            }
        }
        
        // ================================
        // SEGUIMIENTO FACIAL Y DISTORSIONES
        // ================================
        function startFaceTracking() {
            function detectFaces() {
                if (!isARActive || !faceModel) return;
                
                faceModel.estimateFaces({
                    input: video,
                    returnTensors: false,
                    flipHorizontal: false,
                    predictIrises: true
                }).then(predictions => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    clearARDots();
                    
                    if (predictions.length > 0) {
                        const face = predictions[0];
                        drawARFacePoints(face.scaledMesh);
                        applyARDistortions(face);
                        triggerAREffects();
                    }
                    
                    animationId = requestAnimationFrame(detectFaces);
                }).catch(error => {
                    console.error('Error en detección facial:', error);
                    animationId = requestAnimationFrame(detectFaces);
                });
            }
            
            detectFaces();
        }
        
        function drawARFacePoints(landmarks) {
            arInterface.innerHTML = '';
            
            landmarks.forEach((point, index) => {
                if (index % 5 === 0) { // Mostrar solo algunos puntos para performance
                    const dot = document.createElement('div');
                    dot.className = 'face-point';
                    dot.style.left = point[0] + 'px';
                    dot.style.top = point[1] + 'px';
                    
                    // Color basado en la posición
                    const colorValue = (index % 3 === 0) ? 'var(--medical-blue)' : 
                                     (index % 3 === 1) ? 'var(--medical-pink)' : 
                                     'var(--medical-green)';
                    dot.style.background = colorValue;
                    
                    arInterface.appendChild(dot);
                }
            });
        }
        
        function applyARDistortions(face) {
            const landmarks = face.scaledMesh;
            
            // Aplicar diferentes distorsiones según el modo
            switch(currentDistortionMode) {
                case 'soft':
                    applySoftDistortions(landmarks);
                    break;
                case 'medium':
                    applyMediumDistortions(landmarks);
                    break;
                case 'intense':
                    applyIntenseDistortions(landmarks);
                    break;
                case 'chaos':
                    applyChaosDistortions(landmarks);
                    break;
            }
        }
        
        function applySoftDistortions(landmarks) {
            // Ondas suaves alrededor de los ojos
            createWave(landmarks[33], 'var(--medical-blue)');
            createWave(landmarks[263], 'var(--medical-blue)');
        }
        
        function applyMediumDistortions(landmarks) {
            applySoftDistortions(landmarks);
            
            // Ondas en boca y frente
            createWave(landmarks[13], 'var(--medical-pink)');
            createWave(landmarks[14], 'var(--medical-pink)');
            
            // Efecto de glitch ocasional
            if (Math.random() < 0.1) {
                triggerGlitchEffect();
            }
        }
        
        function applyIntenseDistortions(landmarks) {
            applyMediumDistortions(landmarks);
            
            // Múltiples ondas en toda la cara
            for (let i = 0; i < landmarks.length; i += 20) {
                if (Math.random() < 0.3) {
                    const color = Math.random() > 0.5 ? 'var(--medical-green)' : 'var(--medical-purple)';
                    createWave(landmarks[i], color);
                }
            }
            
            // Glitches más frecuentes
            if (Math.random() < 0.2) {
                triggerGlitchEffect();
            }
        }
        
        function applyChaosDistortions(landmarks) {
            // Distorsión máxima - muchas ondas y efectos
            for (let i = 0; i < landmarks.length; i += 10) {
                const colors = ['var(--medical-blue)', 'var(--medical-pink)', 'var(--medical-green)', 'var(--medical-purple)'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                createWave(landmarks[i], randomColor);
            }
            
            // Glitches constantes
            if (Math.random() < 0.4) {
                triggerGlitchEffect();
            }
            
            // Mensajes aleatorios
            if (Math.random() < 0.1) {
                showRandomARMessage();
            }
        }
        
        function createWave(centerPoint, color) {
            const wave = document.createElement('div');
            wave.className = 'distortion-wave';
            wave.style.left = centerPoint[0] + 'px';
            wave.style.top = centerPoint[1] + 'px';
            wave.style.borderColor = color;
            wave.style.animationDuration = (1 + Math.random() * 2) + 's';
            
            arInterface.appendChild(wave);
            
            // Remover después de la animación
            setTimeout(() => {
                if (wave.parentNode) {
                    wave.parentNode.removeChild(wave);
                }
            }, 2000);
        }
        
        function clearARDots() {
            const dots = arInterface.querySelectorAll('.face-point');
            dots.forEach(dot => {
                if (dot.parentNode) {
                    dot.parentNode.removeChild(dot);
                }
            });
        }
        
        // ================================
        // EFECTOS ESPECIALES AR
        // ================================
        function triggerGlitchEffect() {
            glitchOverlay.style.opacity = '0.3';
            setTimeout(() => {
                glitchOverlay.style.opacity = '0';
            }, 100);
        }
        
        function triggerAREffects() {
            // Efectos aleatorios basados en el modo
            const effectChance = {
                'soft': 0.02,
                'medium': 0.05,
                'intense': 0.1,
                'chaos': 0.2
            }[currentDistortionMode];
            
            if (Math.random() < effectChance) {
                showRandomARMessage();
            }
        }
        
        function showRandomARMessage() {
            const message = arMessages[Math.floor(Math.random() * arMessages.length)];
            arMessage.textContent = `"${message}"`;
            arMessage.classList.add('message-visible');
            
            setTimeout(() => {
                arMessage.classList.remove('message-visible');
            }, 4000);
        }
        
        // ================================
        // CONTROLES AR
        // ================================
        function setARDistortionMode(mode) {
            currentDistortionMode = mode;
            
            // Actualizar botones
            document.querySelectorAll('.ar-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Efecto de transición
            triggerGlitchEffect();
        }
        
        // ================================
        // MANEJO DE RESIZE
        // ================================
        window.addEventListener('resize', () => {
            if (renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
        
        // ================================
        // LIMPIEZA
        // ================================
        window.addEventListener('beforeunload', () => {
            isARActive = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (faceModel) {
                faceModel.dispose();
            }
        });
        
        // ================================
        // INICIALIZACIÓN
        // ================================
        // Mostrar pantalla de inicio automáticamente
        window.addEventListener('load', () => {
            startScreen.style.display = 'flex';
        });
    </script>
</body>
</html>
